# WebSocket 401自动重连测试指南

## 🧪 测试目的

验证当token过期后，WebSocket连接能够自动重新连接并继续接收数据。

## 🔧 测试准备

### 1. 确保使用新的WebSocket管理器

确认camera页面已经使用了新的`createWebSocketManager`：

```typescript
// 应该看到这样的代码
import { createWebSocketManager } from '../../services/api'

const wsManager = createWebSocketManager('wss://wobufang.com//notice/ws/wordlings')
```

### 2. 检查日志输出

在控制台中应该能看到以下类型的日志：
- `WebSocket连接使用token: xxx`
- `WebSocket连接成功`
- `检测到token更新，重新连接WebSocket`

## 🚀 测试步骤

### 方案一：模拟401错误（推荐）

1. **打开camera页面**
   - 确保WebSocket连接状态显示"已连接"

2. **模拟token过期**
   ```javascript
   // 在浏览器控制台或小程序调试器中执行
   Taro.setStorageSync('accessToken', 'invalid_token_to_trigger_401')
   ```

3. **上传图片触发401**
   - 选择图片上传
   - 系统会检测到401并自动重新登录
   - 观察控制台日志

4. **验证WebSocket重连**
   - 查看控制台是否有"重连所有WebSocket连接"的日志
   - 确认WebSocket状态仍然显示"已连接"
   - 验证能否正常接收识别数据

### 方案二：使用调试按钮

1. **断开WebSocket**
   - 在camera页面，如果WebSocket状态显示"未连接"
   - 会出现"🔄 重连WebSocket"按钮

2. **点击重连按钮**
   - 点击重连按钮
   - 观察连接状态变化
   - 验证重连后能否正常工作

### 方案三：长时间测试

1. **长时间保持页面开启**
   - 保持camera页面开启几小时
   - 等待token自然过期

2. **上传图片测试**
   - 尝试上传图片
   - 验证是否能自动处理401并重连WebSocket

## ✅ 验证要点

### 1. 日志检查

正常流程应该看到：
```
图片上传检测到401，开始重新登录
→ 自动重新登录成功
→ 开始重连所有WebSocket连接，共1个
→ 检测到token更新，重新连接WebSocket
→ WebSocket连接使用token: new_token_here
→ WebSocket连接成功
→ 所有WebSocket重连完成
```

### 2. 功能验证

- [ ] WebSocket连接状态正确显示
- [ ] 401后能自动重新登录
- [ ] WebSocket能自动重连
- [ ] 重连后能正常接收数据
- [ ] 用户体验流畅，无需手动操作

### 3. 错误情况处理

- [ ] 网络异常时有合适的错误提示
- [ ] 重连失败时有重试机制
- [ ] 最终失败时引导用户重新进入

## 🐛 常见问题排查

### 问题1：WebSocket重连后仍收不到数据

**可能原因：**
- 服务器端token验证有延迟
- WebSocket连接建立成功但服务器还没开始推送数据

**解决方案：**
- 检查服务器端日志
- 确认token在服务器端已更新
- 可以尝试手动重连按钮

### 问题2：重连过程中出现错误

**可能原因：**
- 网络连接不稳定
- 服务器WebSocket服务异常

**解决方案：**
- 检查网络连接
- 查看服务器端WebSocket服务状态
- 确认WebSocket URL是否正确

### 问题3：401检测不到

**可能原因：**
- 服务器返回的状态码不是401
- 请求没有经过我们的拦截器

**解决方案：**
- 检查服务器返回的实际状态码
- 确认使用的是修改后的API服务

## 📊 性能监控

### 监控指标

1. **重连时间** - 从401检测到WebSocket重连完成的时间
2. **成功率** - 自动重连的成功率
3. **数据连续性** - 重连前后数据接收的连续性

### 优化建议

1. **减少重连时间**
   - 可以调整重连延迟时间
   - 优化token刷新速度

2. **提高成功率**
   - 增加重试机制
   - 改善错误处理

3. **改善用户体验**
   - 添加重连过程的loading提示
   - 提供手动重连选项

## 🎯 测试结果

测试完成后，请确认：

✅ **基本功能**
- [ ] 401自动检测工作正常
- [ ] 自动重新登录成功
- [ ] WebSocket自动重连成功
- [ ] 数据接收恢复正常

✅ **用户体验**
- [ ] 过程对用户透明，无感知
- [ ] 没有数据丢失
- [ ] 错误提示友好

✅ **稳定性**
- [ ] 并发请求处理正确
- [ ] 重连机制稳定可靠
- [ ] 异常情况处理得当

测试通过后，WebSocket 401自动处理功能即可正常使用！